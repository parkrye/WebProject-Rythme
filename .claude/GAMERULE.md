# 게임 규칙서

## 게임 개요
**네트워크 웹 리듬 퍼즐 게임**

출제자가 피아노로 멜로디를 연주하면, 다른 플레이어들이 해당 멜로디를 듣고 따라 연주하여 가장 비슷하게 연주한 사람이 점수를 얻는 멀티플레이어 게임

---

## 게임 흐름

```
[닉네임 입력] → [대기방] → [방 생성/입장] → [모드 선택] → [게임/연주] → [결과]
                    │
                    └─→ [개인방] (로컬 솔로 모드)
```

---

## 방 모드

방장이 방 생성 시 선택할 수 있는 두 가지 모드

### 게임 모드 (Game Mode)
| 항목 | 설명 |
|------|------|
| 아이콘 | 🎯 |
| 설명 | 출제자의 멜로디를 따라하며 점수를 겨루는 모드 |
| 특징 | 출제 → 듣기 → 도전 → 판정 → 결과 순환 |
| 점수 | 유사도 기반 점수 시스템 적용 |
| 최소 인원 | 2명 |

### 합주 모드 (Ensemble Mode)
| 항목 | 설명 |
|------|------|
| 아이콘 | 🎵 |
| 설명 | 모두 함께 자유롭게 연주하며 즐기는 모드 |
| 특징 | 실시간 연주 공유, 모두 동시 연주 가능 |
| 점수 | 점수 시스템 없음 |
| 최소 인원 | 1명 |

### 합주 모드 진행 흐름
```
[방장 연주 시작] → [모든 플레이어 자유 연주] → [방장 종료 또는 퇴장]
```

- **실시간 공유**: 모든 플레이어의 연주가 실시간으로 다른 플레이어에게 전달
- **녹음 없음**: 녹음 기능 비활성화
- **점수 없음**: 점수/등급 시스템 비활성화
- **자유 입퇴장**: 게임 중에도 자유롭게 입퇴장 가능

---

## 개인방 (솔로 모드)

로컬에서 동작하는 1인용 모드. 서버 연결 없이 연습 및 AI 대전 가능.

### 모드 종류

| 모드 | 설명 |
|------|------|
| **자유 연습** | 피아노 건반을 자유롭게 연주 |
| **AI 도전** | AI가 출제한 멜로디를 듣고 따라하기 |
| **문제 출제** | 멜로디를 녹음하면 AI가 도전 |

### AI 난이도

| 난이도 | 음 개수 | 템포 (ms) | 실수율 |
|--------|---------|-----------|--------|
| 쉬움 | 4~6개 | 400~600 | 40% |
| 보통 | 6~10개 | 300~500 | 25% |
| 어려움 | 8~14개 | 200~400 | 10% |

### 진행 흐름

**AI 도전 모드:**
```
[난이도 선택] → [AI 멜로디 듣기] → [녹음 시작] → [제출] → [결과 확인]
```

**문제 출제 모드:**
```
[난이도 선택] → [멜로디 녹음] → [제출] → [AI 도전 중] → [결과 확인]
```

### 결과 화면
- 총 일치율 + 등급 (PERFECT/GREAT/GOOD/MISS)
- 세부 일치율 슬라이드 바 5개
- 출제곡 / 내 연주 / AI 연주 재생 버튼

---

## 참가자 규칙

| 항목 | 값 |
|------|-----|
| 최소 인원 | 2명 (AI 포함 가능) |
| 최대 인원 | 6명 |
| AI 플레이어 | 방장이 빈 슬롯에 추가 가능 |

### 역할
- **방장**: 방을 생성한 플레이어. 게임 시작, AI 추가 권한 보유
- **출제자**: 현재 턴에서 멜로디를 녹음하는 플레이어
- **도전자**: 출제자의 멜로디를 따라 연주하는 플레이어

---

## 라운드 진행

### 게임 페이즈 흐름
```
idle → recording → listening → challenging → judging → result → (다음 턴 또는 종료)
```

### 1단계: 출제자 대기 (idle, 3초)
- 순번에 따라 자동 선정
- 출제 순서: 입장 순서대로 순환
- 화면에 출제자 표시 (👑 아이콘)

### 2단계: 녹음 (recording, 20초)
- **출제자만 피아노 연주 가능** (다른 플레이어 키보드 비활성화)
- "녹음 시작" 버튼 클릭 후 연주
- 녹음 중 연주한 음과 타이밍이 저장됨
- **최대 녹화 시간: 10초**
- "녹음 완료" 버튼 또는 녹화 10초/페이즈 20초 경과로 종료

### 3단계: 문제 듣기 (listening, 5초)
- **모든 플레이어에게 출제자의 멜로디 자동 재생**
- 키보드 비활성화 상태
- 집중해서 멜로디 암기

### 4단계: 도전 (challenging, 20초)
- **출제자를 제외한 모든 플레이어가 녹음 방식으로 도전**
- "녹음 시작" 버튼 클릭 후 연주 (녹음 중에만 키보드 활성화)
- **최대 도전 녹음 시간: 10초**
- "제출" 버튼으로 완료 또는 녹음 10초/페이즈 20초 경과 시 자동 제출
- 미제출 시 해당 턴 0점 처리

### 5단계: 판정 (judging, 2초)
- 서버에서 각 도전자의 연주를 출제자 연주와 비교
- 유사도 계산 후 순위 결정

### 6단계: 결과 발표 (result, 20초)
- 라운드 승자 발표 (🏆 아이콘, 네온 하이라이트)
- **비교 재생**: 출제자 녹음본과 1위 도전자 녹음본 비교 재생
- **일치율 슬라이드 바 표시**:
  - 1위 도전자의 총 일치율 (항상 표시)
  - 자신이 1위가 아닌 경우, 자신의 일치율도 함께 표시
- **세부 일치율 슬라이드 바 (하단 표시)**:
  - 음 정확도 (25%)
  - 음 순서 (20%)
  - 타이밍 정확도 (20%)
  - 악기 일치 (15%)
  - 템포 유지 (10%)
  - 음 개수 (10%)
- 획득 점수 및 등급 표시 (PERFECT/GREAT/GOOD/MISS)
- **스킵 기능**: 모든 플레이어가 "넘기기" 버튼 클릭 시 즉시 다음 턴으로 진행

---

## 피아노 규격

### 음역
| 구분 | 음 |
|------|-----|
| 흰 건반 | C4, D4, E4, F4, G4, A4, B4, C5 (8개) |
| 검은 건반 | C#4, D#4, F#4, G#4, A#4 (5개) |
| 총 | 13개 음 (1옥타브 + 1음) |

### 악기 종류 (10종)
| 악기 | 설명 | 음색 특징 |
|------|------|----------|
| 피아노 | 기본 악기 | 빠른 어택, 자연스러운 감쇠 |
| 오르간 | 교회 오르간 | 지속음, 풍성한 배음 |
| 일렉 기타 | 전기 기타 | 톱니파, 중간 감쇠 |
| 베이스 | 저음 악기 | 낮은 옥타브, 둥근 음색 |
| 신스 리드 | 리드 신디사이저 | 톱니파, 느린 어택 |
| 신스 패드 | 패드 신디사이저 | 삼각파, 몽환적 |
| 비브라폰 | 진동 악기 | 사인파 + 트레몰로 |
| 칩튠 | 8비트 게임 | 사각파, 짧은 감쇠 |
| 플루트 | 관악기 | 부드러운 사인파 |
| 브라스 | 금관악기 | 톱니파, 밝은 음색 |

### 녹음 데이터 형식
```typescript
interface Note {
  note: string;      // 음 이름 (예: "C4", "F#4")
  timestamp: number; // 녹음 시작 기준 경과 시간 (ms)
}

// 예시
[
  { note: "C4", timestamp: 0 },
  { note: "E4", timestamp: 250 },
  { note: "G4", timestamp: 500 },
  { note: "C5", timestamp: 750 }
]
```

---

## 점수 시스템

### 유사도 계산 방식
| 요소 | 가중치 | 설명 |
|------|--------|------|
| 음 정확도 | 25% | 올바른 음을 눌렀는지 (틀린 음 비율) |
| 음 순서 | 20% | 연주한 음의 순서가 얼마나 일치하는지 |
| 타이밍 정확도 | 20% | 각 음의 연주 시점이 얼마나 일치하는지 |
| 악기 일치 | 15% | 같은 악기를 사용했는지 |
| 템포 유지 | 10% | 전체적인 연주 속도가 일정하게 유지되는지 |
| 음 개수 | 10% | 연주한 음의 총 개수가 얼마나 일치하는지 |

### 점수 부여
| 유사도 | 등급 | 출제자 점수 | 도전자 점수 |
|--------|------|-------------|-------------|
| 90% 이상 | PERFECT | +100 | +100 |
| 70~89% | GREAT | +70 | +70 |
| 50~69% | GOOD | +50 | +50 |
| 50% 미만 | MISS | +30 | +30 |
| 도전자 없음 | - | +20 | - |

### 보너스 점수
- **올 퍼펙트**: 모든 도전자가 90% 이상 → 출제자 +50 보너스
- **유일한 정답자**: 한 명만 70% 이상 → 해당 도전자 +30 보너스

---

## 라운드 시스템

### 총 턴 수 계산
```
총 턴 수 = 플레이어 수 × 3라운드
```

| 참가자 수 | 총 턴 수 | 설명 |
|-----------|----------|------|
| 2명 | 6턴 | 각 플레이어가 3번씩 출제 |
| 3명 | 9턴 | 각 플레이어가 3번씩 출제 |
| 4명 | 12턴 | 각 플레이어가 3번씩 출제 |
| 5명 | 15턴 | 각 플레이어가 3번씩 출제 |
| 6명 | 18턴 | 각 플레이어가 3번씩 출제 |

### 출제 순서
- 입장 순서대로 순환
- 라운드마다 같은 순서로 반복

---

## 승리 조건

### 턴 승리
- 해당 턴에서 가장 높은 유사도를 기록한 도전자

### 최종 승리
- 모든 턴 종료 후 총 점수가 가장 높은 플레이어
- 동점 시: 1등 횟수 > PERFECT 횟수 > 먼저 입장한 플레이어 순

---

## AI 플레이어

### 특징
- 방장만 추가 가능 (대기 중에만)
- 항상 준비 완료 상태
- 의도적으로 낮은 점수로 플레이 (플레이어가 이기기 쉬움)

### 난이도 (현재: Easy 고정)
| 난이도 | 목표 유사도 | 특징 |
|--------|-------------|------|
| Easy | 30~50% | 초보자도 쉽게 이길 수 있음 |

### AI 출제 패턴
- 간단한 멜로디 생성 (4~6개 음)
- 순차적 음 진행 (C4→D4→E4→F4 등)

### AI 도전 패턴
- 2~7초 랜덤 딜레이 후 자동 제출
- 의도적으로 음을 틀리거나 타이밍 오차 추가

---

## 특수 상황 처리

### 플레이어 이탈
- 게임 중 이탈 시 해당 플레이어 슬롯은 비워둠
- 남은 플레이어로 게임 계속 진행
- 이탈한 플레이어의 출제 턴은 건너뜀

### 방 삭제 조건
- 모든 사람 플레이어가 나가면 방 자동 삭제
- AI만 남아도 방 삭제

### 방장 이전
- 방장이 나가면 다른 사람 플레이어에게 자동 이전
- AI에게는 방장 이전되지 않음

---

## 시간 설정

| 페이즈 | 시간 | 비고 |
|--------|------|------|
| idle | 3초 | |
| recording | 20초 | 최대 녹화 시간: 10초 |
| listening | 5초 | |
| challenging | 20초 | 최대 도전 시간: 10초 |
| judging | 2초 | |
| result | 20초 | 모든 플레이어 스킵 시 즉시 종료 |

---

## 멜로디 저장

### 개요
- 녹음한 멜로디를 파일로 저장하거나 BGM으로 설정 가능
- `.rthm` 확장자의 텍스트 기반 에셋 파일 사용
- JSON 형식으로 멜로디 데이터 저장

### 저장 옵션
| 옵션 | 설명 |
|------|------|
| 파일로 저장 | `.rthm` 파일로 다운로드 |
| 로비 BGM | 로비 화면 BGM으로 설정 |
| 게임 BGM | 게임 중 BGM으로 설정 |
| 결과 BGM | 결과 화면 BGM으로 설정 |

### 멜로디 파일 형식 (.rthm)
```json
{
  "version": "1.0",
  "type": "melody",
  "name": "내 멜로디",
  "author": "Unknown",
  "createdAt": 1702656000000,
  "duration": 5000,
  "instrument": "piano",
  "notes": [
    { "note": "C4", "timestamp": 0 },
    { "note": "E4", "timestamp": 250 },
    { "note": "G4", "timestamp": 500 }
  ]
}
```

### BGM 멜로디 파일
- `type: "bgm"`으로 설정 시 루프 재생
- `loopStart`, `loopEnd` 필드로 루프 구간 지정 가능

---

## 커스텀 BGM

### 개요
- 사용자가 직접 BGM을 업로드하여 기본 BGM 대신 사용 가능
- 업로드된 BGM은 브라우저 IndexedDB에 저장 (영구 보관)
- 다음 접속 시 자동으로 저장된 BGM 재생

### BGM 우선순위
1. 멜로디 BGM (녹음한 멜로디)
2. 파일 BGM (업로드한 음악 파일)
3. 기본 BGM (프로시저럴 생성)

### BGM 종류
| 종류 | 재생 시점 |
|------|----------|
| 로비 BGM | 대기방 화면 |
| 게임 BGM | 게임 진행 중 |
| 결과 BGM | 최종 결과 화면 |

### 지원 형식
- MP3, WAV, OGG
- 최대 파일 크기: 10MB

### 설정 방법
1. 설정 화면에서 "BGM 설정" 진입
2. 원하는 BGM 종류의 "업로드" 버튼 클릭
3. 음악 파일 선택
4. 저장 완료 후 자동 적용

### 기본 BGM (프로시저럴 생성)
- 커스텀 BGM이 없을 경우 Web Audio API로 생성된 BGM 자동 재생
- 16초 반복, 2중주 이상의 화음 사용
- "삭제" 버튼으로 커스텀 BGM 제거 시 기본 BGM으로 복귀

| 종류 | 스타일 | 코드 진행 |
|------|--------|----------|
| 로비 BGM | 몽환적 앰비언트 + 아르페지오 | Am - F - C - G |
| 게임 BGM | 긴장감 있는 신스웨이브 | Em - C - G - D |
| 결과 BGM | 밝고 승리감 있는 멜로디 | C - G - Am - F |
